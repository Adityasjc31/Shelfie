# ==========================================
# API GATEWAY CONFIGURATION (From Config Server)
# ==========================================
# Common configs (Eureka, Logging patterns, Circuit Breaker defaults, etc.) 
# are inherited from application.properties
# Only gateway-specific configurations here

server.port=9080
spring.application.name=api-gateway

# ==========================================
# GATEWAY-SPECIFIC EUREKA METADATA
# ==========================================
eureka.instance.metadata-map.service-type=gateway
eureka.instance.health-check-url-path=/actuator/health

# ==========================================
# SPRING CLOUD GATEWAY CONFIGURATION
# ==========================================
spring.cloud.gateway.enabled=true

# Global timeout settings
spring.cloud.gateway.httpclient.connect-timeout=3000
spring.cloud.gateway.httpclient.response-timeout=5s

# Connection pool settings
spring.cloud.gateway.httpclient.pool.type=ELASTIC
spring.cloud.gateway.httpclient.pool.max-connections=500
spring.cloud.gateway.httpclient.pool.acquire-timeout=45000

# Discovery locator
spring.cloud.gateway.discovery.locator.enabled=false
spring.cloud.gateway.discovery.locator.lower-case-service-id=true

# ==========================================
# AUTHENTICATION SERVICE CONFIGURATION
# ==========================================
auth.service.url=lb://authentication-service
auth.service.validate-endpoint=/api/v1/auth/validate

# Authentication Hook (set to false to bypass auth during development)
auth.enabled=true

# Mock user data when auth.enabled=false
auth.mock.user-id=dev-user-001
auth.mock.username=dev@example.com
auth.mock.roles=CUSTOMER

# ==========================================
# GATEWAY SECRET TOKEN (Internal Service Auth)
# ==========================================
# Secret header used to authenticate requests from API Gateway to backend services
# This prevents direct access to microservices, enforcing all traffic through the gateway
# Set enabled=false to disable this security feature during development
gateway.secret.enabled=true
gateway.secret.header-name=X-Gateway-Secret
gateway.secret.token=${GATEWAY_SECRET_TOKEN:dev-gateway-secret-change-in-production}

# ==========================================
# CORS CONFIGURATION
# ==========================================
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-origins=*
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-methods=GET,POST,PUT,DELETE,PATCH,OPTIONS
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-headers=*
spring.cloud.gateway.globalcors.cors-configurations.[/**].allow-credentials=true
spring.cloud.gateway.globalcors.cors-configurations.[/**].max-age=3600

# ==========================================
# CIRCUIT BREAKER INSTANCES (Gateway-Specific)
# ==========================================
# Default config inherited from application.properties
resilience4j.circuitbreaker.instances.authCircuitBreaker.base-config=default
resilience4j.circuitbreaker.instances.bookCircuitBreaker.base-config=default
resilience4j.circuitbreaker.instances.inventoryCircuitBreaker.base-config=default
resilience4j.circuitbreaker.instances.orderCircuitBreaker.base-config=default
resilience4j.circuitbreaker.instances.reviewCircuitBreaker.base-config=default
resilience4j.circuitbreaker.instances.userCircuitBreaker.base-config=default

# ==========================================
# TIMELIMITER CONFIGURATION (Gateway-Specific)
# ==========================================
# Default timeout increased from 1s to prevent false 503s on slower inter-service calls
resilience4j.timelimiter.configs.default.timeout-duration=5s
resilience4j.timelimiter.configs.default.cancel-running-future=false

# Per-instance timelimiter (using default config)
resilience4j.timelimiter.instances.authCircuitBreaker.base-config=default
resilience4j.timelimiter.instances.bookCircuitBreaker.base-config=default
resilience4j.timelimiter.instances.inventoryCircuitBreaker.base-config=default
resilience4j.timelimiter.instances.orderCircuitBreaker.base-config=default
resilience4j.timelimiter.instances.reviewCircuitBreaker.base-config=default
resilience4j.timelimiter.instances.userCircuitBreaker.base-config=default

# ==========================================
# RATE LIMITER INSTANCES (Gateway-Specific)
# ==========================================
# Default config inherited from application.properties
resilience4j.ratelimiter.instances.authRateLimiter.limit-for-period=50
resilience4j.ratelimiter.instances.authRateLimiter.limit-refresh-period=1s

# ==========================================
# GATEWAY-SPECIFIC LOGGING OVERRIDES
# ==========================================
logging.level.com.book.management.api_gateway=DEBUG
logging.level.org.springframework.cloud.gateway=DEBUG
logging.level.reactor.netty=INFO
logging.file.name=logs/api-gateway.log

# ==========================================
# GATEWAY-SPECIFIC ACTUATOR ENDPOINTS
# ==========================================
management.endpoints.web.exposure.include=health,info,metrics,prometheus,gateway,env,routes,filters
management.endpoint.gateway.enabled=true
management.metrics.enable.gateway=true

# Info endpoint (Gateway-specific)
info.app.name=API Gateway
info.app.description=Common API Gateway for Digital Bookstore Microservices
info.app.version=1.0.0
info.app.services=book-service,inventory-service,order-service,review-service,user-service,authentication-service

# ==========================================
# SECURITY HEADERS (Gateway-Specific)
# ==========================================
gateway.security.headers.enabled=true
gateway.security.headers.x-content-type-options=nosniff
gateway.security.headers.x-frame-options=DENY
gateway.security.headers.x-xss-protection=1; mode=block
gateway.security.headers.strict-transport-security=max-age=31536000

# ==========================================
# CUSTOM GATEWAY PROPERTIES
# ==========================================
gateway.timeout.connect=3000
gateway.timeout.read=5000
gateway.timeout.write=5000
gateway.retry.max-attempts=3
gateway.retry.backoff-multiplier=2
gateway.loadbalancer.enabled=true
gateway.loadbalancer.use-raw-status-code-in-response-data=true

# ==========================================
# WEBCLIENT CONFIGURATION (Gateway-Specific)
# ==========================================
spring.webflux.base-path=/
webclient.connection-timeout=3000
webclient.read-timeout=5000
webclient.write-timeout=5000
webclient.max-in-memory-size=10MB

# ==========================================
# ROLE-BASED ACCESS CONTROL (RBAC) CONFIGURATION
# ==========================================
# Enable or disable role-based authorization
rbac.enabled=true

# RBAC Rules - Define which roles can access specific endpoints
# Format: rbac.rules[index].path, rbac.rules[index].methods, rbac.rules[index].roles

# ---------- USER SERVICE ADMIN ENDPOINTS ----------
# Only ADMIN can view all users
rbac.rules[0].path=/api/v1/user
rbac.rules[0].methods=GET
rbac.rules[0].roles=ADMIN

# Only ADMIN can view users by role
rbac.rules[1].path=/api/v1/user/role/**
rbac.rules[1].methods=GET
rbac.rules[1].roles=ADMIN

# Only ADMIN can deactivate/reactivate users
rbac.rules[2].path=/api/v1/user/**/deactivate
rbac.rules[2].methods=PATCH
rbac.rules[2].roles=ADMIN

rbac.rules[3].path=/api/v1/user/**/reactivate
rbac.rules[3].methods=PATCH
rbac.rules[3].roles=ADMIN

# Only ADMIN can delete users
rbac.rules[4].path=/api/v1/user/**
rbac.rules[4].methods=DELETE
rbac.rules[4].roles=ADMIN

# ---------- BOOK SERVICE ADMIN ENDPOINTS ----------
# Only ADMIN can add books
rbac.rules[5].path=/api/v1/book/add
rbac.rules[5].methods=POST
rbac.rules[5].roles=ADMIN

# Only ADMIN can update books
rbac.rules[6].path=/api/v1/book/update/**
rbac.rules[6].methods=PATCH
rbac.rules[6].roles=ADMIN

# Only ADMIN can delete books
rbac.rules[7].path=/api/v1/book/delete/**
rbac.rules[7].methods=DELETE
rbac.rules[7].roles=ADMIN

# ---------- INVENTORY SERVICE ADMIN ENDPOINTS ----------
# Only ADMIN can create inventory
rbac.rules[8].path=/api/v1/inventory/create
rbac.rules[8].methods=POST
rbac.rules[8].roles=ADMIN

# Only ADMIN can reduce inventory (stock management)
rbac.rules[9].path=/api/v1/inventory/**/reduce
rbac.rules[9].methods=PATCH
rbac.rules[9].roles=ADMIN

# Only ADMIN can restock inventory
rbac.rules[10].path=/api/v1/inventory/**/restock
rbac.rules[10].methods=PATCH
rbac.rules[10].roles=ADMIN

# Only ADMIN can update inventory
rbac.rules[11].path=/api/v1/inventory/**
rbac.rules[11].methods=PUT
rbac.rules[11].roles=ADMIN

# Only ADMIN can delete inventory
rbac.rules[12].path=/api/v1/inventory/**
rbac.rules[12].methods=DELETE
rbac.rules[12].roles=ADMIN

# ---------- ORDER SERVICE ADMIN ENDPOINTS ----------
# Only ADMIN can view all orders
rbac.rules[13].path=/api/v1/order/getAll
rbac.rules[13].methods=GET
rbac.rules[13].roles=ADMIN

# Only ADMIN can update order status
rbac.rules[14].path=/api/v1/order/**/status
rbac.rules[14].methods=PATCH,PUT
rbac.rules[14].roles=ADMIN

# ---------- REVIEW SERVICE - Both roles can create reviews ----------
# Reviews are allowed for all authenticated users (CUSTOMER and ADMIN)
# No specific rule needed - defaults to allowing authenticated users

# ==========================================
# MONITORING & TRACING (Gateway-Specific)
# ==========================================
spring.cloud.gateway.metrics.enabled=true
gateway.request-id.header=X-Request-ID
gateway.request-id.generate=true
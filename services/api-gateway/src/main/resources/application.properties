# ==========================================
# API GATEWAY CONFIGURATION
# ==========================================
spring.application.name=api-gateway
server.port=8080

# ==========================================
# CONFIG SERVER CONFIGURATION
# ==========================================
spring.config.import=optional:configserver:http://localhost:8888
spring.cloud.config.enabled=true
spring.cloud.config.fail-fast=false
spring.cloud.config.retry.max-attempts=3
spring.cloud.config.retry.initial-interval=1000

# ==========================================
# EUREKA CLIENT CONFIGURATION
# ==========================================
eureka.client.service-url.defaultZone=http://localhost:8761/eureka/
eureka.client.register-with-eureka=true
eureka.client.fetch-registry=true
eureka.instance.prefer-ip-address=true
eureka.instance.lease-renewal-interval-in-seconds=30

# Gateway instance metadata
eureka.instance.metadata-map.version=1.0
eureka.instance.metadata-map.service-type=gateway
eureka.instance.health-check-url-path=/actuator/health

# ==========================================
# SPRING CLOUD GATEWAY CONFIGURATION
# ==========================================
spring.cloud.gateway.enabled=true

# Global timeout settings
spring.cloud.gateway.httpclient.connect-timeout=3000
spring.cloud.gateway.httpclient.response-timeout=5s

# Connection pool settings
spring.cloud.gateway.httpclient.pool.type=ELASTIC
spring.cloud.gateway.httpclient.pool.max-connections=500
spring.cloud.gateway.httpclient.pool.acquire-timeout=45000

# Enable discovery locator (optional - we're using explicit routes)
spring.cloud.gateway.discovery.locator.enabled=false
spring.cloud.gateway.discovery.locator.lower-case-service-id=true

# ==========================================
# ROUTE CONFIGURATION
# ==========================================
# Routes are configured in GatewayConfig.java
# This section documents the route paths

# Authentication Service: /auth/** → lb://authentication-service
# Book Service: /books/** → lb://book-service
# Inventory Service: /inventory/** → lb://inventory-service
# Order Service: /orders/** → lb://order-service
# Review Service: /reviews/** → lb://review-service
# User Service: /users/** → lb://user-service

# ==========================================
# AUTHENTICATION SERVICE CONFIGURATION
# ==========================================
auth.service.url=lb://authentication-service
auth.service.validate-endpoint=/api/v1/auth/validate

# JWT Configuration (for validation)
jwt.secret=your_jwt_secret_key_here_replace_in_production
jwt.expiration=86400000

# ==========================================
# CORS CONFIGURATION
# ==========================================
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-origins=*
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-methods=GET,POST,PUT,DELETE,PATCH,OPTIONS
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-headers=*
spring.cloud.gateway.globalcors.cors-configurations.[/**].allow-credentials=true
spring.cloud.gateway.globalcors.cors-configurations.[/**].max-age=3600

# ==========================================
# CIRCUIT BREAKER CONFIGURATION (Resilience4j)
# ==========================================
# Circuit Breaker for all services
resilience4j.circuitbreaker.configs.default.register-health-indicator=true
resilience4j.circuitbreaker.configs.default.sliding-window-size=10
resilience4j.circuitbreaker.configs.default.minimum-number-of-calls=5
resilience4j.circuitbreaker.configs.default.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.configs.default.wait-duration-in-open-state=30s
resilience4j.circuitbreaker.configs.default.failure-rate-threshold=50
resilience4j.circuitbreaker.configs.default.slow-call-duration-threshold=3s
resilience4j.circuitbreaker.configs.default.slow-call-rate-threshold=50

# Individual circuit breakers
resilience4j.circuitbreaker.instances.authCircuitBreaker.base-config=default
resilience4j.circuitbreaker.instances.bookCircuitBreaker.base-config=default
resilience4j.circuitbreaker.instances.inventoryCircuitBreaker.base-config=default
resilience4j.circuitbreaker.instances.orderCircuitBreaker.base-config=default
resilience4j.circuitbreaker.instances.reviewCircuitBreaker.base-config=default
resilience4j.circuitbreaker.instances.userCircuitBreaker.base-config=default

# ==========================================
# RETRY CONFIGURATION
# ==========================================
resilience4j.retry.configs.default.max-attempts=3
resilience4j.retry.configs.default.wait-duration=1s
resilience4j.retry.configs.default.enable-exponential-backoff=true
resilience4j.retry.configs.default.exponential-backoff-multiplier=2

# ==========================================
# RATE LIMITER CONFIGURATION
# ==========================================
# Global rate limiting
resilience4j.ratelimiter.configs.default.limit-for-period=100
resilience4j.ratelimiter.configs.default.limit-refresh-period=1s
resilience4j.ratelimiter.configs.default.timeout-duration=0s

# Rate limiters for specific services
resilience4j.ratelimiter.instances.authRateLimiter.limit-for-period=50
resilience4j.ratelimiter.instances.authRateLimiter.limit-refresh-period=1s

# ==========================================
# TIME LIMITER CONFIGURATION
# ==========================================
resilience4j.timelimiter.configs.default.timeout-duration=5s
resilience4j.timelimiter.configs.default.cancel-running-future=true

# ==========================================
# LOGGING CONFIGURATION
# ==========================================
logging.level.root=INFO
logging.level.com.book.management.book.gateway=DEBUG
logging.level.org.springframework.cloud.gateway=DEBUG
logging.level.org.springframework.web=INFO
logging.level.reactor.netty=INFO

# Logging Pattern
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [${spring.application.name}] %-5level %logger{36} - %msg%n
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [${spring.application.name}] %-5level %logger{36} - %msg%n

# Log File Configuration
logging.file.name=logs/api-gateway.log
logging.file.max-size=10MB
logging.file.max-history=30
logging.file.total-size-cap=100MB

# ==========================================
# ACTUATOR CONFIGURATION
# ==========================================
management.endpoints.web.exposure.include=health,info,metrics,prometheus,gateway,env,routes,filters
management.endpoint.health.show-details=always
management.endpoint.health.show-components=always
management.endpoint.gateway.enabled=true

# Health indicators
management.health.circuitbreakers.enabled=true
management.health.ratelimiters.enabled=true

# Gateway metrics
management.metrics.enable.gateway=true

# Info endpoint
info.app.name=API Gateway
info.app.description=Common API Gateway for Digital Bookstore Microservices
info.app.version=1.0.0
info.app.services=book-service,inventory-service,order-service,review-service,user-service,authentication-service

# ==========================================
# SECURITY HEADERS
# ==========================================
# These will be added by filters
gateway.security.headers.enabled=false
gateway.security.headers.x-content-type-options=nosniff
gateway.security.headers.x-frame-options=DENY
gateway.security.headers.x-xss-protection=1; mode=block
gateway.security.headers.strict-transport-security=max-age=31536000

# ==========================================
# CUSTOM GATEWAY PROPERTIES
# ==========================================
# Request timeout
gateway.timeout.connect=3000
gateway.timeout.read=5000
gateway.timeout.write=5000

# Retry configuration
gateway.retry.max-attempts=3
gateway.retry.backoff-multiplier=2

# Load balancing
gateway.loadbalancer.enabled=true
gateway.loadbalancer.use-raw-status-code-in-response-data=true

# ==========================================
# WEBCLIENT CONFIGURATION
# ==========================================
spring.webflux.base-path=/
webclient.connection-timeout=3000
webclient.read-timeout=5000
webclient.write-timeout=5000
webclient.max-in-memory-size=10MB

# ==========================================
# MONITORING & TRACING
# ==========================================
# Enable request tracking
spring.cloud.gateway.metrics.enabled=true

# Request ID header
gateway.request-id.header=X-Request-ID
gateway.request-id.generate=true
